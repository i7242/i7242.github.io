<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/libs/highlight/github.min.css"> <link rel=stylesheet  href="/css/franklin.css"> <link rel=stylesheet  href="/css/poole_lanyon.css"> <link rel=stylesheet  href="/css/adjust.css"> <link rel=icon  href="/assets/bdx.png"> <title>Retry by Macro</title> <input type=checkbox  class=sidebar-checkbox  id=sidebar-checkbox > <div class=sidebar  id=sidebar > <div class=sidebar-item > <p> Find more ... </p> </div> <nav class=sidebar-nav > <a class="sidebar-nav-item " href="/">Home</a> <a class=sidebar-nav-item  href="https://github.com/i7242">GitHub</a> <a class=sidebar-nav-item  href="https://scholar.google.com/citations?user=x8k-UiMAAAAJ&hl=zh-CN">Google Scholar</a> </nav> <div class=sidebar-item > <p>&copy; i7242 | Xingyu Yan.</p> </div> </div> <!-- Wrap is the content to shift when toggling the sidebar. We wrap the content to avoid any CSS collisions with our real content. --> <div class=wrap > <div class=masthead > <div class=container > <h3 class=masthead-title > <a href="/" title=Home >i7242 | Xingyu Yan</a> <small>一吃一大碗， 一睡一整天</small> </h3> </div> </div> <div class="container content"> <div class=franklin-content > <h1 id=retry_failed_request_by_julia_macro ><a href="#retry_failed_request_by_julia_macro" class=header-anchor >Retry failed request by Julia macro</a></h1> <p>When build micro services, we call many dependencies to gather data. Most of the time we will have 3 times of exponential backoff retry. In Java, we can create an annotation like <code>@Retry</code> to enable auto retry when <code>RetryableException</code> was thrown.</p> <p>We can use Julia&#39;s macro to do similar thing:</p> <pre><code class="julia hljs"><span class=hljs-keyword >macro</span> retriable(f, n=<span class=hljs-number >3</span>, base=<span class=hljs-number >2</span>)
    <span class=hljs-keyword >quote</span>
        <span class=hljs-keyword >for</span> i <span class=hljs-keyword >in</span> <span class=hljs-number >1</span>:$n
            <span class=hljs-keyword >try</span>
                $f
                <span class=hljs-keyword >break</span>
            <span class=hljs-keyword >catch</span> e
                <span class=hljs-keyword >if</span> i == $n
                    <span class=hljs-meta >@error</span> <span class=hljs-string >&quot;failed all retries...&quot;</span>
                <span class=hljs-keyword >else</span>
                    <span class=hljs-meta >@warn</span> <span class=hljs-string >&quot;failed call dependency, will retry later&quot;</span>
                    sleep($base^i)
                <span class=hljs-keyword >end</span>
            <span class=hljs-keyword >end</span>
        <span class=hljs-keyword >end</span>
    <span class=hljs-keyword >end</span>
<span class=hljs-keyword >end</span></code></pre> <p>When exception was catched, we will retry it later with given limited times. Expression that calls the dependency service is always required. Simple test:</p> <pre><code class="julia hljs">test_fun() = rand() ≤ <span class=hljs-number >0.5</span> ? throw(<span class=hljs-built_in >ArgumentError</span>(<span class=hljs-string >&quot;test_fun failed&quot;</span>)) : println(<span class=hljs-string >&quot;200&quot;</span>)

<span class=hljs-meta >@retriable</span> test_fun()
<span class=hljs-comment ># example output</span>
<span class=hljs-comment ># 200</span>

<span class=hljs-meta >@retriable</span> test_fun() <span class=hljs-number >2</span>
<span class=hljs-meta >@retriable</span> test_fun() <span class=hljs-number >2</span> <span class=hljs-number >5</span>
<span class=hljs-comment ># example output</span>
<span class=hljs-comment ># ┌ Warning: failed call dependency, will retry later</span>
<span class=hljs-comment ># └ @ Main ~/Playground/retry_macro.jl:15</span>
<span class=hljs-comment ># ┌ Error: failed all retries...</span>
<span class=hljs-comment ># └ @ Main ~/Playground/retry_macro.jl:13</span></code></pre> <div class=page-foot > <div class=copyright > &copy; i7242 | Xingyu Yan. Last modified: February 09, 2023. Website built with <a href="https://julialang.org">Julia</a> and <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a>. </div> </div> </div> </div> </div> <label for=sidebar-checkbox  class=sidebar-toggle ></label>